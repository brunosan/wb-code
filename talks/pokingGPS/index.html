<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">

<title>Poking around with 50 Million GPS points</title>

<meta name="description" content="Quick open tools to mess with massive* data">
<meta name="author" content="Bruno Sanchez-andrade Nuno">

<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

<link rel="stylesheet" href="css/reveal.css">
<link rel="stylesheet" href="css/theme/black.css" id="theme">

<!-- Code syntax highlighting -->
<link rel="stylesheet" href="lib/css/zenburn.css">

<!-- Printing and PDF exports -->
<script>
var link = document.createElement( 'link' );
link.rel = 'stylesheet';
link.type = 'text/css';
link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
document.getElementsByTagName( 'head' )[0].appendChild( link );
</script>

<!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
</head>

<body>

<div class="reveal">

  <!-- Any section element inside of this container is displayed as a slide -->
  <div class="slides">
    <section>
      <h3>Poking 5 million GPS locations</h3>
      <h3></h3>
      <small>Comments? <a href="http://twitter.com/brunosan">@brunosan</a></small> <br>
      <small>Edits? <a href="http://github.com/brunosan/wb-code/talks/pokingGps">Github repo</a></small>
    </section>
    <section>
      <h3>Poking 50 million GPS locations</h3>
      <h3>with a Best Buy laptop</h3>
      <small>Comments? <a href="http://twitter.com/brunosan">@brunosan</a></small> <br>
      <small>Edits? <a href="http://github.com/brunosan/wb-code/talks/pokingGps">Github repo</a></small>
    </section>

    <section data-markdown>
      <script type="text/template">
  ## The data 
  A *lot* of this 
    
    id;adjustedtimestamp;battery;boot;charging;failednetwork;gpserror;heading;imei;lat;lon;panic;received;sent;shape;shutdown;signal;timestamp;velocity;websocket
    85319703;2013-09-18 16:16:00;;;;;10;57;356097050895537;10.3002443313599;123.872734069824;;2013-09-18 16:16:26.331;;0101000020E6100000000000A0B9992440000000E0DAF75E40;;;2013-09-18 16:16:00;9;t
    85319704;2013-09-18 16:16:00;;;;;10;58;356097050895537;10.3004837036133;123.873085021973;;2013-09-18 16:16:26.331;;0101000020E610000000000000D9992440000000A0E0F75E40;;;2013-09-18 16:16:00;8;t
    85319705;2013-09-18 16:16:00;;;;;10;58;356097050895537;10.3006353378296;123.873306274414;;2013-09-18 16:16:26.331;;0101000020E6100000000000E0EC99244000000040E4F75E40;;;2013-09-18 16:16:00;3;t
    85319706;2013-09-18 16:16:00;;;;;10;57;356097050895537;10.3007659912109;123.873504638672;;2013-09-18 16:16:26.331;;0101000020E610000000000000FE99244000000080E7F75E40;;;2013-09-18 16:16:00;5;t
    85319707;2013-09-18 16:15:54;;;;;10;61;355600057392837;10.2939691543579;123.898536682129;;2013-09-18 16:16:26.911;;0101000020E61000000000002083962440000000A081F95E40;;;2013-09-18 16:15:54;0;t
    85319708;2013-09-18 16:15:59;;;;;10;61;355600057392837;10.2939691543579;123.898536682129;;2013-09-18 16:16:26.911;;0101000020E61000000000002083962440000000A081F95E40;;;2013-09-18 16:15:59;0;t
    85319709;2013-09-18 16:15:59;;;;;10;61;355600057392837;10.2939691543579;123.898536682129;;2013-09-18 16:16:26.911;;0101000020E61000000000002083962440000000A081F95E40;;;2013-09-18 16:15:59;0;t
    85319710;2013-09-18 16:15:59;;;;;20;61;355600057392837;10.2939691543579;123.898536682129;;2013-09-18 16:16:26.911;;0101000020E61000000000002083962440000000A081F95E40;;;2013-09-18 16:15:59;0;t
    85319711;2013-09-18 16:15:59;;;;;15;61;355600057392837;10.2939767837524;123.898628234863;;2013-09-18 16:16:26.911;;0101000020E610000000000020849624400000002083F95E40;;;2013-09-18 16:15:59;0;t
      </script>
    </section>
    <section data-markdown>
      <script type="text/template">
### What do we want to do with it?

  * How many records?
  * General statistics (Direct record questions)
  * Maps/Plots
  * Greographically process the dots (GIS).
<hr>
### How do we want to do it?

  * As cheaply/open/replicable/scalable as possible. 
      </script>
    </section>

    <section data-markdown>
      <script type="text/template">
## If it were just a few lines ...

  Many [open] tools to visualize the data

  We can test it picking just a few lines. (and `;` -> `,`.)
    
      head -100 locationupdate.csv | sed -e 's/;/,/g' > 100.csv
      </script>
    </section>

    <section>
      <h3>Mapbox</h3>

      1.- Drop the file on <a href='http://www.mapbox.com/editor'>mapbox.com/editor</a>
      <iframe width='100%' height='500px' frameBorder='0' src='https://a.tiles.mapbox.com/v4/brunosan.lc0g4l6f/attribution,zoompan,zoomwheel,geocoder,share.html?access_token=pk.eyJ1IjoiYnJ1bm9zYW4iLCJhIjoic3FUc1dJWSJ9.v0525WacYWcsHM1KtbZitg'></iframe>
    </section>

    <section >
      <h3>CartoDB</h3>

      1.- Drop the file on <a href='http://www.cartodb.com/'>cartodb.com</a>
      <iframe width='100%' height='520' frameborder='0' src='http://brunosan.cartodb.com/viz/da06be4c-c144-11e4-aa68-0e4fddd5de28/embed_map' allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen></iframe>
    </section>
    <section>
      <h3>QGIS</h3>

      1.- Add CSV layer.</br>
      (2.- Add OpenLayers plugin for the map backdrop.)
      <img src='/media/qgis-100.png' width='75%'>
    <p>... and many other options. </p>
    </section>

    <section data-markdown>
      <script type="text/template">
<p>But this quick tools slow down and break with >>1000 dots </p>
<p>- Even counting the lines takes time:</p>

    $time wc -l $data 
    50.004.568  
    -> 3.5 minutes

<p>- With `parallel` (and 4 cores) you can speed it up.</p>

    $time cat  $data | parallel --block 10M wc -l | awk '{s+=$1} END {print s}'
    50.004.568  
    -> 1 minute! (1 million/second)

(The awk step aggregates the partial counts.)</br>
With `parallel --pipepart` tweaks you can get ~10x faster, but few operations are throughput limited

<p>- But nothing faster (and dirtier) than divinding the file size by the line size in bytes:</p>
    
    $file_size=`du -b $data | cut -f1`
    $line_size=`head -2 $data | tail -1 | wc -c`
    $echo $file_size/$line_size | bc`
    50.214.969
    -> 2 miliseconds
      </script>
    </section>
    <section >
    <h2> Map reducing</h2> 
      <ul>
        <li>Map: per-record questions</li>
        <li>Reduce: Aggregate the results of those questions.</lib>
      </ul>

<p>E.g. Rides per day of week</p>
    
<pre><code data-trim class='perl'>
   #!/usr/bin/perl -w
   use strict;
   use Time::Piece;

   my %ocurr;
   while (<>) {
     my @data = split /[;]/; #split csv
     my $t = Time::Piece->strptime($data[-3],"%Y-%m-%d %H:%M:%S"); #parse time
     my $field=$t->_wday; #get day of week
     $ocurr{$field} = 0 if (not exists $ocurr{$field});
     $ocurr{$field}++
   }

   foreach my $field (keys %ocurr) {
     printf "$field $ocurr{$field}\n"; #print results
   }
</code></pre>

    </section>
     <section data-markdown>
      <script type="text/template">
#Reduce

    cat ~/wb-data/Holly/pre/locationupdate.csv| parallel --pipe --blocksize 128M -j 200% ./map-dow.pl | ./reduce.pl   
    gnuplot plot-by-dow.gnu

![](media/dow.png)
      </script>
    </section>
     <section data-markdown>
      <script type="text/template">
```
```
      </script>
    </section>
     <section data-markdown>
      <script type="text/template">
```
```
      </script>
    </section>
     <section data-markdown>
      <script type="text/template">
```
```
      </script>
    </section>
     <section data-markdown>
      <script type="text/template">
```
```
      </script>
    </section>
              </div>

            </div>

            <script src="lib/js/head.min.js"></script>
            <script src="js/reveal.js"></script>

            <script>

// Full list of configuration options available at:
// https://github.com/hakimel/reveal.js#configuration
            Reveal.initialize({
controls: true,
progress: true,
history: true,
center: true,

transition: 'slide', // none/fade/slide/convex/concave/zoom

// Optional reveal.js plugins
dependencies: [
{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
{ src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
{ src: 'plugin/zoom-js/zoom.js', async: true },
{ src: 'plugin/notes/notes.js', async: true }
]
});

            </script>

            </body>
            </html>
